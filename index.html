<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiUser-WikiStats</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 20px auto; max-width: 950px; line-height: 1.4; background: #f8f9fa; color: #202122; }
        .container { background: white; padding: 25px; border: 1px solid #c8ccd1; border-radius: 2px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        h2 { border-bottom: 1px solid #a2a9b1; padding-bottom: 10px; margin-top: 0; color: #36c; }
        .input-section { margin-bottom: 20px; padding: 15px; background: #fcfcfc; border: 1px solid #e2e2e2; border-radius: 4px; }
        .search-container { position: relative; margin-bottom: 10px; }
        #userSearch { width: 100%; padding: 12px; border: 2px solid #36c; border-radius: 4px; font-size: 15px; box-sizing: border-box; }
        #suggestions { position: absolute; width: 100%; background: white; border: 1px solid #ccc; z-index: 1000; max-height: 180px; overflow-y: auto; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #eaf3ff; }
        .bulk-area { width: 100%; height: 80px; padding: 10px; border: 1px solid #a2a9b1; border-radius: 4px; font-family: monospace; box-sizing: border-box; margin-top: 10px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; border: 1px inset #eee; padding: 10px; min-height: 40px; border-radius: 4px; background: #fff; }
        .chip { background: #36c; color: white; padding: 5px 12px; border-radius: 16px; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .chip span { cursor: pointer; font-weight: bold; background: rgba(255,255,255,0.2); border-radius: 50%; width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; }
        .flex { display: flex; gap: 10px; margin-bottom: 15px; }
        .flex div { flex: 1; }
        input, select { padding: 8px; border: 1px solid #a2a9b1; width: 100%; box-sizing: border-box; border-radius: 2px; }
        .btn-main { background: #36c; color: white; padding: 12px; border: none; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; border-radius: 2px; }
        .btn-secondary { background: #72777d; color: white; padding: 8px; border: none; cursor: pointer; margin-top: 5px; font-size: 13px; border-radius: 2px; }
        button:hover { opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #a2a9b1; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        .total-row { background: #eee; font-weight: bold; }
        .status { padding: 10px; background: #fff3cd; margin: 10px 0; display: none; border-radius: 2px; text-align: center; font-weight: bold; }
        td a { color: #36c; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>MultiUser-WikiStats</h2>

    <div class="flex">
        <div>
            <label>Project:</label>
            <select id="project" onchange="toggleLang()">
                <option value="wikipedia">Wikipedia</option>
                <option value="wikisource">Wikisource</option>
                <option value="wikidata">Wikidata</option>
                <option value="commons">Wikimedia Commons</option>
            </select>
        </div>
        <div id="langDiv">
            <label>Language Code:</label>
            <input type="text" id="lang" value="pa">
        </div>
    </div>

    <div class="input-section">
        <div class="search-container">
            <label>Option 1: Search & Add Live</label>
            <input type="text" id="userSearch" placeholder="Type to find user..." autocomplete="off">
            <div id="suggestions"></div>
        </div>

        <div style="margin-top:15px;">
            <label>Option 2: Paste List (Comma or New Line)</label>
            <textarea id="bulkInput" class="bulk-area" placeholder="User1, User2, User3..."></textarea>
            <button class="btn-secondary" onclick="importBulk()">Add to Selection</button>
        </div>
    </div>

    <div class="chip-container" id="chipContainer"></div>
    <div style="text-align: right; margin-bottom: 10px;">
        <small style="color:#666; cursor:pointer;" onclick="clearAll()">[Clear All Users]</small>
    </div>

    <div class="flex">
        <div><label>Start Date:</label><input type="date" id="start"></div>
        <div><label>End Date:</label><input type="date" id="end"></div>
    </div>

    <button class="btn-main" onclick="run()">Generate Report</button>

    <div id="status" class="status"></div>

    <table id="resTable" style="display:none;">
        <thead id="resHead"></thead>
        <tbody id="resBody"></tbody>
        <tfoot id="resFoot"></tfoot>
    </table>
</div>

<script>
let selectedUsers = new Set();

function getDomain() {
    const p = document.getElementById('project').value;
    const l = document.getElementById('lang').value;
    if (p === 'wikidata') return 'www.wikidata.org';
    if (p === 'commons') return 'commons.wikimedia.org';
    return `${l}.${p}.org`;
}

function toggleLang() {
    const p = document.getElementById('project').value;
    document.getElementById('langDiv').style.display = (p === 'wikidata' || p === 'commons') ? 'none' : 'block';
}

// LIVE SEARCH
const searchInput = document.getElementById('userSearch');
const suggestionsDiv = document.getElementById('suggestions');

searchInput.addEventListener('input', async () => {
    const query = searchInput.value.trim();
    if (query.length < 2) { suggestionsDiv.style.display = 'none'; return; }
    const url = `https://${getDomain()}/w/api.php?action=query&list=allusers&auprefix=${encodeURIComponent(query)}&format=json&origin=*`;
    try {
        const res = await (await fetch(url)).json();
        if (res.query?.allusers) {
            suggestionsDiv.innerHTML = '';
            res.query.allusers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = user.name;
                div.onclick = () => addUser(user.name);
                suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.style.display = 'block';
        }
    } catch(e) {}
});

function addUser(name) {
    if(name) {
        selectedUsers.add(name);
        renderChips();
    }
    searchInput.value = '';
    suggestionsDiv.style.display = 'none';
}

function importBulk() {
    const raw = document.getElementById('bulkInput').value;
    // Split by comma OR new line
    const names = raw.split(/[,\n]/).map(n => n.trim()).filter(n => n);
    names.forEach(n => selectedUsers.add(n));
    renderChips();
    document.getElementById('bulkInput').value = '';
}

function renderChips() {
    const container = document.getElementById('chipContainer');
    container.innerHTML = '';
    selectedUsers.forEach(user => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `${user} <span onclick="removeUser('${user}')">&times;</span>`;
        container.appendChild(chip);
    });
}

function removeUser(name) { selectedUsers.delete(name); renderChips(); }
function clearAll() { selectedUsers.clear(); renderChips(); }

async function run() {
    const proj = document.getElementById('project').value;
    const startVal = document.getElementById('start').value;
    const endVal = document.getElementById('end').value;
    
    if(selectedUsers.size === 0 || !startVal || !endVal) return alert("Please add users and select dates.");

    const start = startVal + "T00:00:00Z";
    const end = endVal + "T23:59:59Z";
    const domain = getDomain();
    
    const status = document.getElementById('status');
    status.style.display = "block";
    status.innerText = "Analyzing history... this may take a moment for large lists.";

    let specialLabel = "New Articles";
    if(proj === 'wikidata') specialLabel = "New Items";
    if(proj === 'commons') specialLabel = "New Uploads";
    if(proj === 'wikisource') specialLabel = "New Pages";

    document.getElementById('resHead').innerHTML = `<tr><th>User</th><th>Total Edits</th><th>${specialLabel}</th></tr>`;
    const tbody = document.getElementById('resBody');
    tbody.innerHTML = "";
    
    let totals = { e: 0, s: 0 };

    for(let user of selectedUsers) {
        let u = { e: 0, s: 0 };
        let uccontinue = "";

        do {
            let url = `https://${domain}/w/api.php?action=query&list=usercontribs&ucuser=${encodeURIComponent(user)}&ucstart=${start}&ucend=${end}&ucdir=newer&uclimit=max&format=json&origin=*&ucprop=title|flags`;
            if (uccontinue) url += `&uccontinue=${uccontinue}`;
            
            const res = await (await fetch(url)).json();
            if(res.query?.usercontribs) {
                res.query.usercontribs.forEach(c => {
                    u.e++;
                    if(c.hasOwnProperty('new')) {
                        if(proj === 'commons' && c.ns === 6) u.s++;
                        else if(c.ns === 0) u.s++;
                    }
                });
            }
            uccontinue = res.continue ? res.continue.uccontinue : "";
        } while(uccontinue);

        const contribLink = `https://${domain}/w/index.php?title=Special:Contributions&target=${encodeURIComponent(user)}&namespace=all&start=${startVal}&end=${endVal}&limit=500`;

        tbody.innerHTML += `<tr>
            <td>${user}</td>
            <td><a href="${contribLink}" target="_blank">${u.e}</a></td>
            <td>${u.s}</td>
        </tr>`;
        totals.e += u.e; totals.s += u.s;
    }

    document.getElementById('resFoot').innerHTML = `<tr class="total-row"><td>GRAND TOTAL</td><td>${totals.e}</td><td>${totals.s}</td></tr>`;
    document.getElementById('resTable').style.display = "table";
    status.style.display = "none";
}
</script>
</body>
</html>
